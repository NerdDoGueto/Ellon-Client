SOUNDS_CONFIG = {
	soundChannel = SoundChannels.Music,
	checkInterval = 500,
	folder = 'music/',
	noSound = 'No sound file for this area.',
}

SOUNDS = {
	-- Divine World   
	{fromPos = {x=8671, y=9644, z=5}, toPos = {x=8876, y=9791, z=8}, priority = 3, sound = "Divineworld.ogg"},
	
		-- Boss
		{fromPos = {x=9025, y=9893, z=15}, toPos = {x=9050, y=9911, z=15}, priority = 1, sound="Boss Episode.ogg"},
		{fromPos = {x=9174, y=9726, z=15}, toPos = {x=9198, y=9745, z=15}, priority = 1, sound="Boss Episode.ogg"},
		{fromPos = {x=9279, y=9933, z=15}, toPos = {x=9315, y=9956, z=15}, priority = 1, sound="Boss Episode.ogg"},
		{fromPos = {x=9396, y=9441, z=15}, toPos = {x=9430, y=9489, z=15}, priority = 1, sound="Boss Episode.ogg"},
		{fromPos = {x=9061, y=9719, z=15}, toPos = {x=9104, y=9759, z=15}, priority = 1, sound="Boss Episode.ogg"},
		{fromPos = {x=9488, y=9755, z=15}, toPos = {x=9536, y=9783, z=15}, priority = 1, sound="Boss Episode.ogg"},
		{fromPos = {x=8778, y=9875, z=15}, toPos = {x=9021, y=9995, z=15}, priority = 1, sound="divine dungeon 1.ogg"},
		{fromPos = {x=9022, y=9912, z=15}, toPos = {x=9061, y=9981, z=15}, priority = 1, sound="divine dungeon 1.ogg"},
		{fromPos = {x=9253, y=9850, z=15}, toPos = {x=9118, y=9745, z=15}, priority = 1, sound="divine dungeon 2.ogg"},
	-- Main
	
		-- Kingdom Ellon
		{fromPos = {x=8166, y=9315, z=1}, toPos = {x=8528, y=9658, z=7}, priority = 1, sound="Kingdomellon.ogg"},
		-- Florest Kingdom Ellon
		{fromPos = {x=8510, y=9278, z=4}, toPos = {x=8716, y=9456, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8377, y=8707, z=4}, toPos = {x=8581, y=9277, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8743, y=8979, z=4}, toPos = {x=8851, y=9450, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8611, y=8704, z=4}, toPos = {x=8907, y=8977, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8729, y=8560, z=4}, toPos = {x=8858, y=8636, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8756, y=8637, z=4}, toPos = {x=8862, y=8788, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8453, y=8951, z=4}, toPos = {x=8851, y=9102, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8724, y=9103, z=4}, toPos = {x=8852, y=9502, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8611, y=9181, z=4}, toPos = {x=8731, y=9281, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8329, y=8929, z=4}, toPos = {x=8386, y=9033, z=7}, priority = 1, sound="Florest.ogg"},
		{fromPos = {x=8518, y=8493, z=5}, toPos = {x=8641, y=8647, z=7}, priority = 1, sound="Cemetery.ogg"},
		{fromPos = {x=8510, y=8605, z=8}, toPos = {x=8720, y=8690, z=14}, priority = 1, sound="Cemetery.ogg"},
		{fromPos = {x=8081, y=9151, z=4}, toPos = {x=8141, y=9189, z=7}, priority = 3, sound="pvp.ogg", "pvp2.ogg", "pvp3.ogg"},
		{fromPos = {x=736, y=638, z=1}, toPos = {x=953, y=805, z=10}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=662, y=732, z=1}, toPos = {x=826, y=864, z=10}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=940, y=1137, z=1}, toPos = {x=748, y=805, z=10}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=667, y=846, z=1}, toPos = {x=765, y=949, z=10}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=681, y=960, z=1}, toPos = {x=753, y=1158, z=10}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=619, y=1082, z=1}, toPos = {x=679, y=1163, z=10}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=672, y=795, z=1}, toPos = {x=942, y=1157, z=10}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=490, y=832, z=1}, toPos = {x=610, y=1126, z=7}, priority = 1, sound="Wasteland.ogg"},
		{fromPos = {x=611, y=847, z=1}, toPos = {x=664, y=1053, z=10}, priority = 1, sound="Wasteland.ogg"},
		{fromPos = {x=665, y=948, z=1}, toPos = {x=673, y=1043, z=10}, priority = 1, sound="Wasteland.ogg"},
		--Kingdom Ellon Island
		{fromPos = {x=8396, y=8636, z=2}, toPos = {x=8493, y=8700, z=7}, priority = 1, sound="kingdom island.ogg"},
		--Beach
		{fromPos = {x=9267, y=9459, z=3}, toPos = {x=9509, y=9605, z=9}, priority = 1, sound="Beach.ogg"},
		--Ice Island
		{fromPos = {x=8050, y=8619, z=4}, toPos = {x=8274, y=9281, z=7}, priority = 1, sound="Iceisland.ogg"},
		{fromPos = {x=7814, y=8674, z=4}, toPos = {x=8066, y=9033, z=7}, priority = 1, sound="Frostisland.ogg"},
		--Anoesha
		{fromPos = {x=8850, y=8979, z=6}, toPos = {x=8919, y=9039, z=8}, priority = 1, sound="Anoesha.ogg"},
		--Dark Forest
		{fromPos = {x=9088, y=8946, z=5}, toPos = {x=9710, y=9398, z=9}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=9635, y=9049, z=8}, toPos = {x=9733, y=9221, z=12}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=9277, y=9386, z=7}, toPos = {x=9517, y=9455, z=12}, priority = 1, sound="Dark Forest.ogg"},
		{fromPos = {x=8580, y=9116, z=4}, toPos = {x=8723, y=9203, z=7}, priority = 1, sound="City.ogg"},
		{fromPos = {x=8660, y=8627, z=4}, toPos = {x=8750, y=8688, z=7}, priority = 1, sound="City2.ogg"},
		--Poi
		{fromPos = {x=8668, y=9320, z=9}, toPos = {x=8765, y=9419, z=12}, priority = 1, sound="Poi.ogg"},
		{fromPos = {x=8398, y=9241, z=12}, toPos = {x=8585, y=9462, z=14}, priority = 1, sound="Poi.ogg"},
		{fromPos = {x=8687, y=9281, z=13}, toPos = {x=8759, y=9355, z=13}, priority = 1, sound="Poi.ogg"},
		-- Blood Castle
		{fromPos = {x=9075, y=9848, z=6}, toPos = {x=9138, y=9979, z=6}, priority = 1, sound="Blood Castle.ogg"},				
} ----------

-- Sound
local rcSoundChannel
local showPosEvent
local playingSound

-- Design
soundWindow = nil
soundButton = nil

function toggle()
  if soundButton:isOn() then
    soundWindow:close()
    soundButton:setOn(false)
  else
    soundWindow:open()
    soundButton:setOn(true)
  end
end

function onMiniWindowClose()
  soundButton:setOn(false)
end

function init()
	for i = 1, #SOUNDS do
		SOUNDS[i].sound = SOUNDS_CONFIG.folder .. SOUNDS[i].sound
	end
	
	connect(g_game, { onGameStart = onGameStart,
                    onGameEnd = onGameEnd })
	
	rcSoundChannel = g_sounds.getChannel(SOUNDS_CONFIG.soundChannel)
	-- rcSoundChannel:setGain(value/COUNDS_CONFIG.volume)

	soundButton = modules.client_topmenu.addRightGameToggleButton('soundButton', tr('Sound Info') .. '', '/images/audio', toggle)
	soundButton:setOn(true)
	
	soundWindow = g_ui.loadUI('rcsound', modules.game_interface.getRightPanel())
	soundWindow:disableResize()
	soundWindow:setup()
	
	if(g_game.isOnline()) then
		onGameStart()
	end
end

function terminate()
	disconnect(g_game, { onGameStart = onGameStart,
                       onGameEnd = onGameEnd })
	onGameEnd()
	soundWindow:destroy()
	soundButton:destroy()
end

function onGameStart()
	stopSound()
	toggleSoundEvent = addEvent(toggleSound, SOUNDS_CONFIG.checkInterval)
end

function onGameEnd()
	stopSound()
	removeEvent(toggleSoundEvent)
end

function isInPos(pos, fromPos, toPos)
	return
		pos.x>=fromPos.x and
		pos.y>=fromPos.y and
		pos.z>=fromPos.z and
		pos.x<=toPos.x and
		pos.y<=toPos.y and
		pos.z<=toPos.z
end

function toggleSound()
	local player = g_game.getLocalPlayer()
	if not player then return end
	
	local pos = player:getPosition()
	local toPlay = nil

	for i = 1, #SOUNDS do
		if(isInPos(pos, SOUNDS[i].fromPos, SOUNDS[i].toPos)) then
			if(toPlay) then
				toPlay.priority = toPlay.priority or 0
				if((toPlay.sound~=SOUNDS[i].sound) and (SOUNDS[i].priority>toPlay.priority)) then
					toPlay = SOUNDS[i]
				end
			else
				toPlay = SOUNDS[i]
			end
		end
	end

	playingSound = playingSound or {sound='', priority=0}
	
	if(toPlay~=nil and playingSound.sound~=toPlay.sound) then
		g_logger.info("RC Sounds: New sound area detected:")
		g_logger.info("  Position: {x=" .. pos.x .. ", y=" .. pos.y .. ", z=" .. pos.z .. "}")
		g_logger.info("  Music: " .. toPlay.sound)
		stopSound()
		playSound(toPlay.sound)
		playingSound = toPlay
	elseif(toPlay==nil) and (playingSound.sound~='') then
		g_logger.info("RC Sounds: New sound area detected:")
		g_logger.info("  Left music area.")
		stopSound()
	end

	toggleSoundEvent = scheduleEvent(toggleSound, SOUNDS_CONFIG.checkInterval)
end

function playSound(sound)
	rcSoundChannel:enqueue(sound, 0)
	setLabel(clearName(sound))
end

function clearName(soundName)
	local explode = string.explode(soundName, "/")
	soundName = explode[#explode]
	explode = string.explode(soundName, ".ogg")
	soundName = ''
	for i = 1, #explode-1 do
		soundName = soundName .. explode[i]
	end
	return soundName
end

function stopSound()
	setLabel(SOUNDS_CONFIG.noSound)
	rcSoundChannel:stop()
	playingSound = nil
end

function setLabel(str)
	soundWindow:recursiveGetChildById('currentSound'):getChildById('value'):setText(str)
end